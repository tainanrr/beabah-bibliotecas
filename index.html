<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Beabah! - Rede de Bibliotecas Comunitárias do Rio Grande do Sul</title>
    <meta name="description" content="Sistema integrado de gestão para a rede de bibliotecas comunitárias do Rio Grande do Sul. Pesquise o acervo, consulte disponibilidade e gerencie empréstimos." />
    <meta name="author" content="Beabah! - Rede de Bibliotecas Comunitárias do Rio Grande do Sul" />
    <meta name="keywords" content="biblioteca, acervo, livros, empréstimo, leitura, cultura, educação, bibliotecas comunitárias" />

    <meta property="og:title" content="Beabah! - Rede de Bibliotecas Comunitárias do Rio Grande do Sul" />
    <meta property="og:description" content="Encontre seu próximo livro no acervo das bibliotecas comunitárias do Rio Grande do Sul." />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Beabah! - Rede de Bibliotecas Comunitárias do Rio Grande do Sul" />
    <meta name="twitter:description" content="Encontre seu próximo livro no acervo das bibliotecas comunitárias do Rio Grande do Sul." />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <link rel="canonical" href="https://beabah.rs.com.br" />
  </head>

  <body>
    <div id="root"></div>

    <!-- ====== VERIFICAÇÃO DE VERSÃO (roda ANTES do React) ====== -->
    <!-- Este script garante que o usuário sempre carregue a versão mais recente do sistema -->
    <!-- Ele compara a versão local com a versão no servidor e força atualização se necessário -->
    <script>
      (function() {
        // Proteção contra loop infinito: se já verificamos nos últimos 10 segundos, pular
        var lastCheck = sessionStorage.getItem('beabah_version_check_ts');
        if (lastCheck && (Date.now() - parseInt(lastCheck)) < 10000) {
          console.log('[VersionCheck] Verificação recente detectada, pulando...');
          return;
        }

        // Buscar version.json do servidor (com cache-busting)
        fetch('/version.json?_t=' + Date.now(), {
          cache: 'no-store',
          headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }
        })
        .then(function(response) {
          if (!response.ok) return null;
          return response.json();
        })
        .then(function(data) {
          if (!data || !data.version) return;

          var remoteVersion = data.version;
          var localVersion = localStorage.getItem('beabah_app_version');

          console.log('[VersionCheck] Versão remota: ' + remoteVersion + ' | Versão local salva: ' + (localVersion || 'nenhuma'));

          // Se é a primeira vez OU se a versão mudou, forçar atualização
          if (localVersion && localVersion !== remoteVersion) {
            console.log('[VersionCheck] ⚠️ VERSÃO DESATUALIZADA! Limpando cache e recarregando...');

            // Marcar timestamp para evitar loop
            sessionStorage.setItem('beabah_version_check_ts', Date.now().toString());

            // Salvar a nova versão
            localStorage.setItem('beabah_app_version', remoteVersion);

            // Limpar caches do Service Worker
            if ('caches' in window) {
              caches.keys().then(function(names) {
                names.forEach(function(name) { caches.delete(name); });
              });
            }

            // Desregistrar Service Workers
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.getRegistrations().then(function(regs) {
                regs.forEach(function(reg) { reg.unregister(); });
              });
            }

            // Forçar recarregamento completo (limpa cache do browser)
            setTimeout(function() {
              window.location.reload(true);
            }, 300);
          } else {
            // Atualizar versão local (para futuras comparações)
            localStorage.setItem('beabah_app_version', remoteVersion);
          }
        })
        .catch(function(err) {
          console.warn('[VersionCheck] Erro ao verificar versão:', err);
        });
      })();
    </script>

    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
