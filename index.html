<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Anti-cache: garante que o browser sempre busque o HTML fresco do servidor -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Beabah! - Rede de Bibliotecas Comunitárias do Rio Grande do Sul</title>
    <meta name="description" content="Sistema integrado de gestão para a rede de bibliotecas comunitárias do Rio Grande do Sul. Pesquise o acervo, consulte disponibilidade e gerencie empréstimos." />
    <meta name="author" content="Beabah! - Rede de Bibliotecas Comunitárias do Rio Grande do Sul" />
    <meta name="keywords" content="biblioteca, acervo, livros, empréstimo, leitura, cultura, educação, bibliotecas comunitárias" />

    <meta property="og:title" content="Beabah! - Rede de Bibliotecas Comunitárias do Rio Grande do Sul" />
    <meta property="og:description" content="Encontre seu próximo livro no acervo das bibliotecas comunitárias do Rio Grande do Sul." />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Beabah! - Rede de Bibliotecas Comunitárias do Rio Grande do Sul" />
    <meta name="twitter:description" content="Encontre seu próximo livro no acervo das bibliotecas comunitárias do Rio Grande do Sul." />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <link rel="canonical" href="https://beabah.rs.com.br" />
  </head>

  <body>
    <div id="root"></div>

    <!-- ====== VERIFICAÇÃO DE VERSÃO (roda ANTES do React) ====== -->
    <!-- Este script é a PRIMEIRA CAMADA de proteção contra versões desatualizadas. -->
    <!-- Funciona independente do React e força atualização automática se necessário. -->
    <script>
      (function() {
        try {
          // Proteção contra loop infinito: se já verificamos nos últimos 15 segundos, pular
          var lastCheck = sessionStorage.getItem('beabah_vc_ts');
          if (lastCheck && (Date.now() - parseInt(lastCheck)) < 15000) {
            console.log('[VersionCheck] Verificação recente detectada, pulando...');
            return;
          }

          // Buscar version.json do servidor (com cache-busting total)
          var xhr = new XMLHttpRequest();
          xhr.open('GET', '/version.json?_nocache=' + Date.now() + Math.random(), true);
          xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
          xhr.setRequestHeader('Pragma', 'no-cache');
          xhr.onreadystatechange = function() {
            if (xhr.readyState !== 4) return;
            if (xhr.status !== 200) return;

            try {
              var data = JSON.parse(xhr.responseText);
              if (!data || !data.version) return;

              var remoteVersion = data.version;
              var localVersion = localStorage.getItem('beabah_app_version');

              console.log('[VersionCheck] Remota: ' + remoteVersion + ' | Local: ' + (localVersion || 'primeira visita'));

              // Forçar atualização se a versão local é diferente da remota
              if (localVersion && localVersion !== remoteVersion) {
                console.log('[VersionCheck] VERSÃO DESATUALIZADA! Forçando atualização...');

                // Marcar timestamp para evitar loop
                sessionStorage.setItem('beabah_vc_ts', Date.now().toString());

                // Salvar a nova versão ANTES de limpar
                localStorage.setItem('beabah_app_version', remoteVersion);

                // Preservar dados essenciais
                var sgbcUser = localStorage.getItem('sgbc_user');

                // Limpar caches do Service Worker
                if ('caches' in window) {
                  caches.keys().then(function(names) {
                    names.forEach(function(name) { caches.delete(name); });
                  });
                }

                // Desregistrar Service Workers
                if ('serviceWorker' in navigator) {
                  navigator.serviceWorker.getRegistrations().then(function(regs) {
                    regs.forEach(function(reg) { reg.unregister(); });
                  });
                }

                // Restaurar dados essenciais que podem ter sido perdidos
                if (sgbcUser) localStorage.setItem('sgbc_user', sgbcUser);

                // Forçar recarregamento completo
                setTimeout(function() {
                  window.location.reload(true);
                }, 200);
                return;
              }

              // Salvar versão local para futuras comparações
              localStorage.setItem('beabah_app_version', remoteVersion);
            } catch(e) {
              console.warn('[VersionCheck] Erro ao processar versão:', e);
            }
          };
          xhr.send();
        } catch(e) {
          console.warn('[VersionCheck] Erro geral:', e);
        }
      })();
    </script>

    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
